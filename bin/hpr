#!/usr/bin/env bash

# Create a GitHub pull request.
# It's `hpr` because that used to mean "hub pull request".
# Now we are using `gh` rather than `hub`, but the name has stuck.

set -euo pipefail # exit on any error, don't allow undefined variables, pass errors through pipes

check-git-push-safety
if [ $? -ne 0 ]
then
  exit 1
fi

gpf
PR_CREATE_OUTPUT=$(gh pr create \
  --title "$(git log -1 --format=%s)" \
  --body "$(git log -1 --format=%b | ruby -r active_support/core_ext/string/filters -e 'puts(ARGF.read.split(/\n\n+/).map(&:squish).join("\n\n").strip)')"
)
echo $?
echo $PR_CREATE_OUTPUT
echo $PR_CREATE_OUTPUT | open-gh-pr
