#!/usr/bin/env bash

# make sure that we're on a branch that's okay to push and that there isn't any debugging code etc

verify-on-ok-branch
if [ $? -ne 0 ]
then
  exit 1
fi

# don't push if there's still debugging code
rg -g '*.rake' -g '*.rb' -g '*.js' -g '*.coffee' -g '*.haml' -g '*.html' -g '*.erb' \
  '^(\s*(fit|fdescribe|fcontext|fspecify|open_page))|(binding\.pry|byebug)'
if [ $? -eq 0 ]
then
  echo
  echo "Easy there, cowboy! Cleanup yo code, first."
  exit 1
fi

# don't push if there are still `!!!` markers in the code
git diff origin/master..HEAD | rg --quiet --fixed-strings '!!!'
if [ $? -eq 0 ]
then
  git diff --name-status master | cut -f2 | xargs rg --with-filename --fixed-strings '!!!'
  echo "Easy there, cowboy! You still have some markers in your code."
  exit 1
fi

# don't push if there are still `!!!` markers in .env.development.local
rg --quiet --fixed-strings '!!!' .env.development.local
if [ $? -eq 0 ]
then
  rg --with-filename --fixed-strings '!!!' .env.development.local
  echo "Easy there, cowboy! You still have some markers in your env file."
  exit 1
fi

# if all of the above checks passed, we're good to push! :)
exit 0
