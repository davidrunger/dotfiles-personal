#!/usr/bin/env ruby
# frozen_string_literal: true

require 'slop'

module Gal
  def self.print_options(options)
    puts(
      options.to_s.dup.
        sub(%r{/Users/david/workspace/dotfiles/bin/}, '').
        sub(%r{gal \[options\]}, 'gal <spec files to run> [options]'),
    )
  end
end

opts =
  Slop.parse do |o|
    o.bool('-b', '--backtrace', 'print backtrace when errors occur or tests fail')
    o.bool('-s', '--skip-spring', 'do not use spring')
    o.bool('-c', '--force-coverage-detail', 'print code coverage info even if 100% covered')
    o.on('-h', '--help', 'view this help info') do
      Gal.print_options(o)
      exit
    end
  end

if opts.arguments.empty?
  Gal.print_options(opts.options)
else
  system(
    {
      'RUBYGEMS_GEMDEPS' => '', # this suppresses a warning from guard
      'RSPEC_BACKTRACE' => opts.backtrace? ? '1' : nil,
      'TARGET_SPEC_FILES' => opts.arguments.join(' '),
      'DISABLE_SPRING' => ENV.fetch('DISABLE_SPRING', opts.skip_spring? ? '1' : nil),
      'SIMPLECOV_FORCE_DETAILS' => opts.force_coverage_detail? ? '1' : nil,
    }.compact,
    'guard -G /Users/david/workspace/dotfiles/guardfiles/run_spec.rb --no-bundler-warning',
  )
end
